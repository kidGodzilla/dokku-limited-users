#!/usr/bin/env bash
# Allow root/admin users to do everything
# Deny access to default users
# Allow access for deployment

set -eo pipefail; [[ $DOKKU_TRACE ]] && set -x

# Debug
# echo "Verifying user authorization for: $SSH_USER | $SSH_NAME for command $3"

SSH_USER=$1
SSH_NAME=$2
# shift 2

# Root and admin users have full access
[[ "$SSH_USER" == "root" ]] && exit 0
[[ "$SSH_NAME" == "admin" ]] && exit 0

# Default users can do nothing
[[ "$SSH_NAME" == "default" ]] && exit 1

# Allow Deploys from dokku user
[[ "$SSH_USER" == "dokku" && $3 == git* ]] && exit 0
[[ "$SSH_USER" == "dokku" && $3 == git-hook ]] && exit 0
[[ "$SSH_USER" == "dokku" && $3 == git-upload-pack ]] && exit 0

# Allow dokku logs
[[ "$SSH_USER" == "dokku" && $3 == logs ]] && exit 0

# Prevent certain flags from being passed to any command
[[ $* == *--rm-container* ]] && exit 1
[[ $* == *--global* ]] && exit 1
[[ $* == *--trace* ]] && exit 1
[[ $* == *--force* ]] && exit 1
[[ $* == *--rm* ]] && exit 1

# Allow users to set config
[[ "$SSH_USER" == "dokku" && $3 == config* ]] && exit 0

# Prevent execution of global domain commands
[[ "$SSH_USER" == "dokku" && $3 == domains:add-global ]] && exit 1
[[ "$SSH_USER" == "dokku" && $3 == domains:clear-global ]] && exit 1
[[ "$SSH_USER" == "dokku" && $3 == domains:remove-global ]] && exit 1
[[ "$SSH_USER" == "dokku" && $3 == domains:set-global ]] && exit 1
[[ "$SSH_USER" == "dokku" && $3 == domains:enable ]] && exit 1
[[ "$SSH_USER" == "dokku" && $3 == domains:disable ]] && exit 1

# Allow all other domain commands
[[ "$SSH_USER" == "dokku" && $3 == domains:* ]] && exit 0

# Allow App start / stop / restarts / restart policy / report
[[ "$SSH_USER" == "dokku" && $3 == ps:report ]] && exit 0
[[ "$SSH_USER" == "dokku" && $3 == ps:restart ]] && exit 0
[[ "$SSH_USER" == "dokku" && $3 == ps:start ]] && exit 0
[[ "$SSH_USER" == "dokku" && $3 == ps:stop ]] && exit 0
[[ "$SSH_USER" == "dokku" && $3 == ps:set-restart-policy ]] && exit 0

# Allow certs commands
[[ "$SSH_USER" == "dokku" && $3 == certs:* ]] && exit 0

# Allow let's encrypt
[[ "$SSH_USER" == "dokku" && $3 == letsencrypt ]] && exit 0

# Allow resource report resource:report
[[ "$SSH_USER" == "dokku" && $3 == resource:report ]] && exit 0




##############################
# Exit, prohibiting all other commands
##############################
# echo "$3"
# echo "Limited users may only deploy and manage their own apps."

exit 1
